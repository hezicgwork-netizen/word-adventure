<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Magic - Smart Loop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { 
            touch-action: manipulation; 
            margin: 0;
            padding: 0;
        }
        .perspective { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        
        /* 转拽 爪注 专拽注   住 */
        html, body, #root { 
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const getFinalConfig = () => {
            try { if (typeof __firebase_config !== 'undefined') return JSON.parse(__firebase_config); } catch(e) {}
            return firebaseConfig;
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(getFinalConfig());
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'english-magic-v2';

        const Icons = {
            Volume: ({ size = 20 }) => (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            ),
            Moon: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            Trash: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        };

        const speak = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        // --- Flashcards with Learning Loop ---
        const Flashcards = ({ words, onFinish, isDark }) => {
            const [queue, setQueue] = useState([...words]);
            const [idx, setIdx] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            const current = queue[idx];

            const handleKnow = (wellKnown) => {
                if (!wellKnown) {
                    setQueue([...queue, current]);
                }
                
                if (idx + 1 < queue.length) {
                    setIdx(idx + 1);
                    setIsFlipped(false);
                } else {
                    onFinish();
                }
            };

            return (
                <div className="flex flex-col flex-grow items-center justify-center space-y-6 py-4">
                    <div className="text-center">
                        <span className="text-xs opacity-50 font-bold"> {idx + 1} 转 {queue.length}</span>
                        <h2 className="text-lg md:text-xl font-black mt-1 italic">砖 1:  转专</h2>
                    </div>
                    
                    <div className="w-full max-w-[280px] md:max-w-xs aspect-[3/4] perspective cursor-pointer" onClick={() => setIsFlipped(!isFlipped)}>
                        <div className={`relative w-full h-full preserve-3d transition-transform duration-500 shadow-2xl rounded-3xl ${isFlipped ? 'rotate-y-180' : ''}`}>
                            <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden rounded-3xl border-4 ${isDark ? 'bg-slate-900 border-sky-500' : 'bg-white border-sky-400'}`}>
                                <h3 className="text-4xl font-black text-center px-4">{current.eng}</h3>
                                <button onClick={(e) => { e.stopPropagation(); speak(current.eng); }} className="mt-6 p-3 bg-sky-100 text-sky-600 rounded-full hover:bg-sky-200 transition-colors"><Icons.Volume size={24} /></button>
                                <p className="mt-4 text-xs opacity-40 font-bold uppercase tracking-widest">抓 驻</p>
                            </div>
                            <div className={`absolute inset-0 flex flex-col items-center justify-center backface-hidden rotate-y-180 rounded-3xl border-4 ${isDark ? 'bg-sky-900 border-white text-white' : 'bg-sky-600 border-white text-white'}`}>
                                <h3 className="text-4xl font-black text-center px-4">{current.heb}</h3>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 w-full max-w-[320px]">
                        <button 
                            onClick={() => handleKnow(false)}
                            className="bg-red-100 text-red-600 py-4 rounded-2xl font-black shadow-md border-b-4 border-red-300 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center"
                        >
                            <span className="text-2xl mb-1"></span>
                            <span className="text-sm">注  注</span>
                        </button>
                        <button 
                            onClick={() => handleKnow(true)}
                            className="bg-green-100 text-green-600 py-4 rounded-2xl font-black shadow-md border-b-4 border-green-300 active:border-b-0 active:translate-y-1 flex flex-col items-center justify-center"
                        >
                            <span className="text-2xl mb-1"></span>
                            <span className="text-sm">注</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- Knowledge Test ---
        const KnowledgeGate = ({ words, onPass, onFail, isDark }) => {
            const [idx, setIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [options, setOptions] = useState([]);
            const [selected, setSelected] = useState(null);

            const current = words[idx];

            useEffect(() => {
                if (!current) return;
                const others = words.filter(w => w.id !== current.id);
                const shuffledOthers = others.sort(() => 0.5 - Math.random()).slice(0, 3);
                const opts = [...shuffledOthers, current].sort(() => 0.5 - Math.random());
                setOptions(opts);
                setSelected(null);
            }, [idx, words]);

            const handleAnswer = (opt) => {
                if (selected) return;
                setSelected(opt.id);
                if (opt.id === current.id) {
                    setScore(s => s + 1);
                    speak(current.eng);
                }
                setTimeout(() => {
                    if (idx + 1 < words.length) setIdx(idx + 1);
                    else {
                        const final = ((score + (opt.id === current.id ? 1 : 0)) / words.length) * 100;
                        if (final >= 70) onPass(); else onFail(final);
                    }
                }, 800);
            };

            return (
                <div className="flex flex-col flex-grow justify-center space-y-4 max-w-sm mx-auto w-full">
                    <div className="text-center">
                        <h2 className="text-xl font-black"> 注专 (70%)</h2>
                        <div className="w-full bg-gray-200 h-2 rounded-full mt-2 overflow-hidden">
                            <div className="bg-sky-500 h-full transition-all duration-300" style={{width: `${((idx + 1) / words.length) * 100}%`}}></div>
                        </div>
                    </div>
                    <div className={`p-8 rounded-3xl text-center border-2 ${isDark ? 'bg-slate-900 border-slate-700' : 'bg-white border-sky-100'}`}>
                        <h3 className="text-3xl font-black text-sky-500">{current.eng}</h3>
                    </div>
                    <div className="grid grid-cols-1 gap-2">
                        {options.map(opt => (
                            <button
                                key={opt.id}
                                onClick={() => handleAnswer(opt)}
                                className={`p-4 rounded-xl font-bold text-lg transition-all border-2 ${
                                    selected === opt.id 
                                        ? (opt.id === current.id ? 'bg-green-500 text-white border-green-600' : 'bg-red-500 text-white border-red-600 animate-shake')
                                        : (isDark ? 'bg-slate-800 border-slate-700 text-white hover:bg-slate-700' : 'bg-white border-sky-50 hover:bg-sky-50')
                                }`}
                            >
                                {opt.heb}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [view, setView] = useState('setup');
            const [wordList, setWordList] = useState([]);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [user, setUser] = useState(null);
            const [savedLists, setSavedLists] = useState([]);
            const [failedScore, setFailedScore] = useState(0);

            // Sync body background with dark mode to prevent white areas
            useEffect(() => {
                document.body.style.backgroundColor = isDarkMode ? "#020617" : "#f0f9ff";
            }, [isDarkMode]);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token).catch(() => auth.signInAnonymously());
                        } else {
                            await auth.signInAnonymously();
                        }
                    }
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsub = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists')
                    .onSnapshot(snap => setSavedLists(snap.docs.map(d => ({...d.data(), id: d.id}))), err => console.error(err));
                return () => unsub();
            }, [user]);

            const startApp = () => {
                const val = document.getElementById('word-input').value;
                const parsed = val.split('\n').map(l => {
                    const parts = l.split(/[,\t\-:|]+/).map(p => p.trim());
                    return parts.length >= 2 ? { eng: parts[0], heb: parts[1], id: Math.random().toString(36).substr(2,9) } : null;
                }).filter(Boolean);
                if (parsed.length) { setWordList(parsed); setView('learning'); }
            };

            const saveList = async () => {
                if (!user || wordList.length === 0) return;
                const name = prompt("转 砖 专砖:");
                if (name) {
                    await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists').add({
                        name,
                        words: wordList,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            };

            return (
                <div className={`min-h-screen transition-colors duration-300 p-4 md:p-6 flex flex-col ${isDarkMode ? 'bg-slate-950 text-white' : 'bg-sky-50 text-slate-900'}`}>
                    <div className="w-full max-w-md mx-auto flex flex-col flex-grow">
                        <header className="relative flex justify-center items-center h-12 mb-6">
                            <h1 className={`text-2xl font-black tracking-tight transition-colors ${isDarkMode ? 'text-yellow-400' : 'text-sky-500'}`}>
                                English Magic
                            </h1>
                            <button 
                                onClick={() => setIsDarkMode(!isDarkMode)} 
                                className={`absolute left-0 w-10 h-10 flex items-center justify-center rounded-xl border transition-all active:scale-90 shadow-sm ${isDarkMode ? 'bg-slate-800 border-slate-700 text-yellow-400' : 'bg-white border-sky-100 text-indigo-600'}`}
                            >
                                {isDarkMode ? <Icons.Sun /> : <Icons.Moon />}
                            </button>
                        </header>

                        {view === 'setup' && (
                            <div className="space-y-6 flex-grow flex flex-col">
                                <div className={`${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-white'} p-5 rounded-3xl shadow-xl border-2 flex flex-col transition-all`}>
                                    <label className="text-sm font-bold opacity-60 mb-2 mr-1">  (转 - 注专转):</label>
                                    <textarea 
                                        id="word-input" 
                                        className={`w-full h-40 p-4 rounded-2xl border-2 outline-none text-left font-bold transition-all ${isDarkMode ? 'bg-slate-950 border-slate-800 focus:border-yellow-500' : 'bg-sky-50 border-sky-100 focus:border-sky-400'}`} 
                                        dir="ltr" 
                                        placeholder="Apple - 转驻&#10;Book - 住驻专"
                                    ></textarea>
                                    <button onClick={startApp} className="w-full bg-sky-500 hover:bg-sky-600 text-white py-4 rounded-2xl font-black text-xl shadow-lg mt-4 transition-all active:scale-95">转 </button>
                                </div>
                                
                                {savedLists.length > 0 && (
                                    <div className="space-y-3">
                                        <h3 className="font-black text-sm opacity-50 mr-1 uppercase tracking-wider">专砖转 砖专转:</h3>
                                        <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                            {savedLists.map(list => (
                                                <div key={list.id} onClick={() => { setWordList(list.words); setView('learning'); }} className={`${isDarkMode ? 'bg-slate-900 border-slate-800 hover:bg-slate-800' : 'bg-white border-white hover:bg-sky-50'} p-4 rounded-2xl shadow-sm flex justify-between items-center cursor-pointer border transition-all`}>
                                                    <span className="font-black">{list.name}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('wordLists').doc(list.id).delete(); }} className="text-red-400 p-2 hover:bg-red-50 rounded-lg transition-colors"><Icons.Trash /></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'learning' && (
                            <>
                                <Flashcards words={wordList} onFinish={() => setView('gate')} isDark={isDarkMode} />
                                <button onClick={saveList} className="mt-4 text-xs font-bold opacity-40 hover:opacity-100 transition-opacity">砖专 专砖  注转</button>
                            </>
                        )}

                        {view === 'gate' && <KnowledgeGate words={wordList} onPass={() => setView('games')} onFail={(s) => { setFailedScore(s); setView('gate-failed'); }} isDark={isDarkMode} />}

                        {view === 'gate-failed' && (
                            <div className="text-center flex-grow flex flex-col justify-center space-y-6">
                                <div className="text-6xl animate-bounce"></div>
                                <h2 className="text-2xl font-black">拽转 {Math.round(failedScore)}%</h2>
                                <p className="opacity-70 font-bold px-4"> 专!  专 注  注 驻注 转  驻转 转 砖拽.</p>
                                <button onClick={() => setView('learning')} className="w-full bg-sky-500 text-white py-4 rounded-2xl font-black shadow-lg">专 </button>
                            </div>
                        )}

                        {view === 'games' && (
                            <div className="flex flex-col flex-grow justify-center space-y-6">
                                <div className="text-center p-8 bg-green-500 rounded-[2rem] text-white shadow-xl transform -rotate-2">
                                    <h2 className="text-3xl font-black italic">注专转! </h2>
                                    <p className="font-bold opacity-90 mt-1">注砖  祝</p>
                                </div>
                                <button onClick={() => setView('setup')} className="bg-sky-500 text-white py-6 rounded-3xl font-black text-2xl shadow-xl active:scale-95 transition-all">砖拽 专 (拽专)</button>
                                <button onClick={() => setView('setup')} className="text-sky-500 font-bold text-center mt-4 p-2 hover:underline">专 转驻专 专砖</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

